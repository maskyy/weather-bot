# weather-bot - тестовое задание

[Проверить бота](https://t.me/naboka_weather_bot)

Telegram-бот для получения текущей температуры и скорости ветра через [OpenWeatherMap](https://openweathermap.org).

Так как API разрешает до 1000 вызовов в сутки, количество запросов в секунду также ограничено до 4 с помощью библиотеки [limiter](https://pypi.org/project/limiter/), а количество запрашиваемых городов - до 10.

Вместо "," как разделителя используется ";", чтобы указывать код страны.

## Примеры запросов и ответов
- `/start`, `/help` - получение справки
```
/start, /help - вывод этой команды

место1;...;место1 - получение погоды городов (до 10)
Примеры запросов:
1. Москва
2. Moscow; London; Paris
3. 1;2;3;4;5;6;7;8;9;10;11
4. notfound
5. petersburg,us;виктория,cl;виктория (2-буквенный код страны)

Ответы:
1.
Город: Moscow, RU (Москва)
Температура: 30.96 °C
Скорость ветра: 5.43 м/с

2.
Город: Moscow, RU (Москва)
Температура: 31.15 °C
Скорость ветра: 5.43 м/с

Город: London, GB (Лондон)
Температура: 17.53 °C
Скорость ветра: 0.89 м/с

Город: Paris, FR (Париж)
Температура: 21.13 °C
Скорость ветра: 4.63 м/с

3. Пожалуйста, укажите не более 10 городов

4. Ошибка: место notfound не найдено

5.
Город: Petersburg, US
Температура: 28.81 °C
Скорость ветра: 1.9 м/с

Город: Victoria, CL (Виктория)
Температура: 8.42 °C
Скорость ветра: 2.68 м/с

Город: Victoria, CA (Виктория)
Температура: 15.8 °C
Скорость ветра: 6.17 м/с
```
- `место1;место2;место3` - запрос на получение погоды одного или нескольких городов (до 10). См. примеры выше

Критические ошибки:
1. Failed to connect to DB - ошибка подключения к БД (неправильная строка подключения или недоступность сервера)
2. Cannot run bot - ошибка запуска бота (неверный токен)

Пользовательские сообщения:
1. Сервис погоды недоступен - исчерпание попыток подключиться к сервису погоды
2. Место не найдено :)
3. Место: ... - иные ошибки в поиске координат локации
4. Получение погоды: ... - ошибки в получении погоды
5. Пожалуйста, укажите не более N городов

## Установка и запуск
Локальный запуск:
1. Установить сервер PostgreSQL (или поднять на Docker)
2. Установить poetry: `pip install poetry`
3. Зайти в папку проекта и активировать окружение: `poetry shell`
4. Установить зависимости: `poetry install --only main`
5. Указать переменные в .env:
  - `LOG_LEVEL` - уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL)
  - `BOT_TOKEN` - токен бота
  - `POSTGRES_{USER,PASSWORD,HOST,PORT,DB}` - подключение к БД
  - `WEATHER_API_TOKEN` - API-токен OpenWeatherMap
6. Из окружения выполнить команду `./run.sh` либо `python -m bot`. Либо запустить `docker-compose up` (пока не работает)

Запуск с docker-compose:
1. Указать переменные в .env. Далее `POSTGRES_HOST = host`
2. `docker-compose up`

Если не работает резолвинг:
1. Установить `POSTGRES_HOST = host` (или другое имя)
2. Запустить БД: `docker-compose run --name host database`
3. Запустить бота: `docker-compose run bot ./run.sh`
